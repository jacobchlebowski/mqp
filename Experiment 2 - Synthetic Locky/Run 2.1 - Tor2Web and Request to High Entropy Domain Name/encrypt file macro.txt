Option Explicit

Sub EncryptFileWithKey(filePath As String, fileKey As String)
    Dim fileURL As String
    Dim outputFileURL As String
    Dim input As Object
    Dim output As Object
    Dim cipher As Object

    fileURL = ConvertToURL(filePath)
    outputFileURL = ConvertToURL(filePath & ".encrypted")

    ' Load the input stream
    input = createUnoService("com.sun.star.io.TextInputStream")
    input.setInputStream(createUnoService("com.sun.star.io.FileInputStream"))
    input.getTextInputStream().setInputStream(fileURL)

    ' Load the output stream
    output = createUnoService("com.sun.star.io.TextOutputStream")
    output.getTextOutputStream().setOutputStream(outputFileURL)

    ' Load the cipher
    cipher = createUnoService("com.sun.star.security.Cipher")

    ' Initialize the cipher with the key
    cipher.initialize(com.sun.star.security.CipherAlgorithm.AES, com.sun.star.security.CipherMode.ENCRYPT, fileKey)

    ' Encrypt and write to the output stream
    Dim buffer(1023) As Byte
    Dim bytesRead As Long

    Do
        bytesRead = input.readBytes(buffer(), UBound(buffer) + 1)
        If bytesRead > 0 Then
            buffer() = cipher.doFinal(buffer(), bytesRead)
            output.writeBytes(buffer(), UBound(buffer) + 1)
        End If
    Loop Until bytesRead = 0

    ' Close the streams
    input.closeInput()
    output.closeOutput()

    MsgBox "File encrypted successfully!", 64, "Encryption Complete"
End Sub
